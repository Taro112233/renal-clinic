// prisma/schemas/counseling.prisma
// ========================================
// Counseling Records & Related Items
// ========================================

model CounselingRecord {
  id              String    @id @default(cuid())
  
  // === ข้อมูลพื้นฐาน ===
  date            DateTime                      // วันที่ทำ C/L (DD/MM/YYYY)
  sequenceNumber  Int?                          // ลำดับในวันนั้น
  patientId       String
  patient         Patient   @relation(fields: [patientId], references: [id])
  pharmacistId    String                        // userId ของเภสัชกรที่ทำ
  pharmacist      User      @relation("PharmacistCounselingRecords", fields: [pharmacistId], references: [id])
  counselingType  CounselingType                // PRE or POST
  
  // === ข้อมูลยา ===
  currentDmards   String?                       // ยา DMARDs ที่ใช้อยู่ (text, เช่น "MTX, HCQ, Pred")
  hasDmards       Boolean   @default(false)     // มี DMARDs หรือไม่
  otherMeds       String?                       // ยาอื่นๆ
  
  // === ซักประวัติ ===
  historyNote     String?                       // Note จากการซักประวัติ (free text)
  
  // === ADR (Adverse Drug Reaction) ===
  adrStatus       AdrStatus @default(NO)        // No, Yes จาก DMARD, Yes จาก HQ, Yes จากยาอื่นๆ, Yes จาก DMARDs+HQ, Yes จาก DMARDs+ยาอื่นๆ
  adrDescription  String?                       // รายละเอียด ADR
  
  // === HQ/CQ Eye Screening (เฉพาะคนที่ใช้ HQ/CQ) ===
  hasHQ              Boolean  @default(false)   // คนไข้มีใช้ยา HQ/CQ?
  eyeScreeningStatus String?                    // ซัก Eye → ตาปกติ, มีปัญหา, ไม่ได้ซัก
  eyeAppointmentStatus EyeAppointmentStatus?    // Yes, No, loss นัด EYE, screen ที่รพ.อื่น/คลินิกอื่น
  consultEyeResult   ConsultEyeResult?          // [if No/loss] Yes = OK consult, No, ไม่ได้ suggest นัด
  prevEyeDate        DateTime?                  // prev. EYE date
  eyeResult          String?                    // EYEล่าสุด: no maculopathy, maculopathy, etc.
  nextEyeDate        DateTime?                  // next EYE date
  popupHQAction      PopupHQAction?             // set new pop, update pop, มี pop-up เดิม, no
  
  // === Compliance / Adherence ===
  complianceStatus   ComplianceStatus            // กินถูก+ครบ, non-compliance
  nonComplianceItems NonComplianceItem[]         // รายละเอียดปัญหา (1-3 รายการ)
  
  // === ยาเหลือ (Leftover medications) ===
  leftoverMeds    String?                       // Text: "ssz=100, losec=30, naproxen=30"
  
  // === Health Behavior ===
  alcoholStatus   String?                       // No, Yes เบียร์, Yes เหล้า/40, Yes เบียร์+เหล้า, Yes ตามเทศกาล
  herbStatus      String?                       // No, อาหารเสริม, นม/อาหารทางการแพทย์
  smokingStatus   String?                       // No, Yes บุหรี่, Yes ยาเส้น
  nsaidFromOther  String?                       // NSAID จากที่อื่น (free text)
  
  // === DRP (Drug Related Problem) / Consult ===
  hasDrp          Boolean  @default(false)      // พบ DRP?
  drpItems        DrpItem[]                     // รายละเอียด DRP (1-2 รายการ)
  
  // === Contraception ===
  contraceptionMethod String?                   // วิธีคุมกำเนิด
  
  // === Medication Error ===
  hasME           Boolean  @default(false)      // พบ ME?
  meDescription   String?                       // รายละเอียด ME
  meLevel         String?                       // Level: A-G (NCC MERP)
  
  // === Lab Values (เจาะแลป) ===
  labDate         DateTime?                     // วันที่เจาะแลป
  wbc             Float?                        // WBC (5000-10000 cells/mm3)
  absoluteNeutrophil Float?                     // Absolute Neutrophil Count
  neutrophilPercent  Float?                     // Neutrophil %
  ast             Float?                        // AST (0-31 U/L)
  alt             Float?                        // ALT (0-34 U/L)
  alp             Float?                        // ALP (40-150 U/L)
  uricAcid        Float?                        // Uric acid (3.6-8.2 mg/dL)
  creatinine      Float?                        // Creatinine (0.55-1.02 mg/dL)
  albumin         Float?                        // Albumin (3.5-5.2 gm/dL)
  hsCRP           Float?                        // hsCRP (<1 mg/L)
  labLevel        String?                       // ระดับปกติ/ผิดปกติ
  
  // === Cyclophosphamide (ถ้ามี) ===
  hasCyclophosphamide Boolean @default(false)
  cyclophosphamideRoute CyclophosphamideRoute?  // ORAL or IV
  cyclophosphamideCumulativeDose Float?         // Cumulative dose (mg)
  
  // === Other Notes ===
  note            String?                       // Note อื่นๆ
  
  // === Meta ===
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([date])
  @@index([patientId])
  @@index([pharmacistId])
  @@index([date, pharmacistId])
  @@index([counselingType])
  @@map("counseling_records")
}

model NonComplianceItem {
  id                String   @id @default(cuid())
  counselingRecordId String
  counselingRecord   CounselingRecord @relation(fields: [counselingRecordId], references: [id], onDelete: Cascade)
  
  orderNumber       Int                          // 1, 2, or 3
  type              NonComplianceType             // ประเภทปัญหา
  description       String?                       // รายละเอียด/ยาที่เกี่ยวข้อง
  
  @@index([counselingRecordId])
  @@map("non_compliance_items")
}

model DrpItem {
  id                String   @id @default(cuid())
  counselingRecordId String
  counselingRecord   CounselingRecord @relation(fields: [counselingRecordId], references: [id], onDelete: Cascade)
  
  orderNumber       Int                          // 1 or 2
  drugName          String                       // ชื่อยาที่เกี่ยวข้อง
  drpType           String                       // ประเภท DRP (free text หรือ enum ตามต้องการ)
  consultResult     String?                      // ผล consult: accept, not accept, pending
  
  @@index([counselingRecordId])
  @@map("drp_items")
}