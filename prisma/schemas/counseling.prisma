// prisma/schemas/counseling.prisma

model CounselingRecord {
  id             String         @id @default(cuid())

  // === ข้อมูลพื้นฐาน ===
  date           DateTime
  sequenceNumber Int?
  patientId      String
  patient        Patient        @relation(fields: [patientId], references: [id])
  pharmacistId   String
  pharmacist     User           @relation("PharmacistCounselingRecords", fields: [pharmacistId], references: [id])
  counselingType CounselingType

  // === ข้อมูลยา ===
  // dmards เก็บเป็น array of SelectOption.value จาก category "dmard"
  // เช่น ["MTX", "HCQ", "PRED"]
  currentDmards  String[]       @default([])
  hasDmards      Boolean        @default(false)
  otherMeds      String?

  // === ซักประวัติ ===
  historyNote    String?

  // === ADR ===
  adrStatus      AdrStatus      @default(NO)
  adrDescription String?

  // === HQ/CQ Eye Screening ===
  hasHQ                Boolean              @default(false)
  // eyeScreeningStatus: SelectOption.value จาก category "eye_screening_status"
  // เช่น "NORMAL", "PROBLEM", "NOT_ASSESSED"
  eyeScreeningStatus   String?
  eyeAppointmentStatus EyeAppointmentStatus?
  consultEyeResult     ConsultEyeResult?
  prevEyeDate          DateTime?
  // eyeResult: SelectOption.value จาก category "eye_result"
  // เช่น "NO_MACULOPATHY", "RO_MACULOPATHY", "DX_MACULOPATHY"
  eyeResult            String?
  nextEyeDate          DateTime?
  popupHQAction        PopupHQAction?

  // === Compliance ===
  complianceStatus   ComplianceStatus
  nonComplianceItems NonComplianceItem[]

  // === ยาเหลือ ===
  // เก็บเป็น JSON array: [{ "drugCode": "1M013B", "drugName": "MTX 2.5 mg", "quantity": 10 }]
  leftoverMeds Json?

  // === Health Behavior ===
  // แต่ละ field เก็บ SelectOption.value จาก category ที่ตรงกัน
  alcoholStatus  String[]       @default([])
  herbStatus     String[]       @default([])
  smokingStatus  String[]       @default([])
  nsaidFromOther String?  // free text

  // === DRP ===
  hasDrp   Boolean   @default(false)
  drpItems DrpItem[]

  // === Contraception ===
  // contraceptionMethod: SelectOption.value จาก category "contraception"
  contraceptionMethod String?

  // === Medication Error ===
  hasME         Boolean @default(false)
  // meType: SelectOption.value จาก category "me_type"
  // เช่น "PRESCRIBING", "DISPENSING", "PROCESSING"
  meType        String?
  meDescription String?
  meLevel       String? // A-G (NCC MERP) — free text / enum เล็กเกินไป ไม่ต้องทำ table

  // === Lab Values ===
  labDate            DateTime?
  wbc                Float?
  absoluteNeutrophil Float?
  neutrophilPercent  Float?
  ast                Float?
  alt                Float?
  alp                Float?
  uricAcid           Float?
  creatinine         Float?
  albumin            Float?
  hsCRP              Float?
  labLevel           String?

  // === Cyclophosphamide ===
  hasCyclophosphamide         Boolean                @default(false)
  cyclophosphamideRoute       CyclophosphamideRoute?
  cyclophosphamideCumulativeDose Float?

  // === Note ===
  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([patientId])
  @@index([pharmacistId])
  @@index([date, pharmacistId])
  @@index([counselingType])
  @@map("counseling_records")
}

model NonComplianceItem {
  id                 String           @id @default(cuid())
  counselingRecordId String
  counselingRecord   CounselingRecord @relation(fields: [counselingRecordId], references: [id], onDelete: Cascade)

  orderNumber Int                // 1, 2, 3
  type        NonComplianceType
  description String?

  @@index([counselingRecordId])
  @@map("non_compliance_items")
}

model DrpItem {
  id                 String           @id @default(cuid())
  counselingRecordId String
  counselingRecord   CounselingRecord @relation(fields: [counselingRecordId], references: [id], onDelete: Cascade)

  orderNumber   Int
  drugCode      String?  // optional: อ้างอิง DrugMaster.drugCode
  drugName      String
  // drpType: SelectOption.value จาก category "drp_type"
  drpType       String
  // consultResult: "ACCEPT" | "NOT_ACCEPT" | "PENDING" — ใช้ string เพราะ simple
  consultResult String?

  @@index([counselingRecordId])
  @@map("drp_items")
}